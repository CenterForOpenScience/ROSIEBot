var test = require('tape')
var sema = require('./')

test('queue pool', function (t) {
  var pool = sema(5)
  var num = 100
  var start = 0
  var curr = 0

  while (start++ < num) {
    pool.take(function () {
      curr++
      pool.release()
      if (curr === num) {
        t.ok(pool.isEmpty(), 'pool empty after all released')
        t.throws(function () {
          t.release()
        }, 'Too many release')
        t.end()
      }
    })
  }
})

test('queue pool defer', function (t) {
  var pool = sema(5)
  var num = 100
  var start = 0
  var curr = 0

  while (start++ < num) {
    pool.take(function () {
      curr++
      // Not releasing the pool
    })
  }
  setTimeout(function () {
    t.equal(curr, 5)
    t.end()
  }, 50)
})
