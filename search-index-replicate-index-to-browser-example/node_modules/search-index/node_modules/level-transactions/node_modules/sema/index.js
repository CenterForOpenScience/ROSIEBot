var setImmediate = global.setImmediate || process.nextTick

function Sema (cap) {
  if (!(this instanceof Sema)) return new Sema(cap)
  this._q = []
  this._taken = 0
  this._cap = cap || 1
}

Sema.prototype.take = function (fn) {
  if (this._taken < this._cap) {
    this._taken++
    setImmediate(fn)
  } else {
    this._q.push(fn)
  }
  return this
}

Sema.prototype.leave = function () {
  if (this._q.length > 0) {
    setImmediate(this._q.shift())
  } else {
    if (this._taken === 0) {
      throw new Error('Too many release.')
    }
    this._taken--
  }
  return this
}

Sema.prototype.isEmpty = function () {
  return this._taken === 0
}

Sema.prototype.acquire = Sema.prototype.take
Sema.prototype.release = Sema.prototype.leave

module.exports = Sema

